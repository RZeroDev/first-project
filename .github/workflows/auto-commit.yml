name: Auto Commit Bot

on:
  schedule:
    - cron: "*/1 * * * *"   # toutes les 30 minutes
  workflow_dispatch:          # permet aussi de lancer manuellement

jobs:
  auto-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Récupérer toute l'historique pour éviter les conflits

      - name: Setup Git
        run: |
          git config --global user.name "RzeroDev"
          git config --global user.email "rzerodeviam@gmail.com"

      - name: Run auto commit script
        run: |
          # IMPORTANT: Synchroniser AVANT de modifier les fichiers
          git fetch origin
          git pull --rebase origin main || {
            echo "Erreur lors du pull, tentative de récupération..."
            git rebase --abort 2>/dev/null || true
            git reset --hard origin/main 2>/dev/null || true
            git pull --rebase origin main || {
              echo "Échec du pull, abandon de cette exécution"
              exit 1
            }
          }
          
          FILES=("index.html" "style.css" "script.js" "app.ts" "index.php")
          DEFAULT_LINE="Ajout de contenu automatique"

          for FILE in "${FILES[@]}"; do
              if [ ! -f "$FILE" ]; then
                  echo "$DEFAULT_LINE" > "$FILE"
                  echo "Créé $FILE"
              else
                  echo "$DEFAULT_LINE" >> "$FILE"
                  echo "Ajouté une ligne à $FILE"
              fi
          done

          git add .
          if git diff --cached --quiet; then
            echo "Aucun changement à commit"
            exit 0
          fi

          git commit -m "Auto commit: $(date)"
          
          # Push avec retry en cas d'échec
          PUSH_ATTEMPTS=0
          MAX_PUSH_ATTEMPTS=3
          while [ $PUSH_ATTEMPTS -lt $MAX_PUSH_ATTEMPTS ]; do
              if git push origin main; then
                  echo "Push réussi"
                  break
              else
                  PUSH_ATTEMPTS=$((PUSH_ATTEMPTS + 1))
                  echo "Échec du push (tentative $PUSH_ATTEMPTS/$MAX_PUSH_ATTEMPTS), pull et retry..."
                  git pull --rebase origin main || {
                      echo "Échec du pull lors du retry"
                      exit 1
                  }
                  if [ $PUSH_ATTEMPTS -eq $MAX_PUSH_ATTEMPTS ]; then
                      echo "Échec du push après $MAX_PUSH_ATTEMPTS tentatives"
                      exit 1
                  fi
              fi
          done

      - name: Send Discord notification
        run: |
          LAST_COMMIT=$(git rev-parse --short HEAD)
          NUM_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD | wc -l)
          COMMIT_URL="https://github.com/RzeroDev/first-project/commit/$LAST_COMMIT"
          COMMIT_MSG="✅ Nouveau commit automatique : [$LAST_COMMIT]($COMMIT_URL) | Fichiers modifiés : $NUM_FILES"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$COMMIT_MSG\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}
